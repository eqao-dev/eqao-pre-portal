<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>授業書類 - EQAO PORTAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #f8f9fc 0%, #e8ecf4 100%);
      min-height: 100vh;
      padding-bottom: 40px;
    }

    /* ヘッダー */
    .header {
      background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 4px 20px rgba(26, 35, 126, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 2px;
      flex: 1;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    /* 説明セクション */
    .intro-section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    .intro-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a237e;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .intro-title .material-icons {
      font-size: 24px;
    }

    .intro-flow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .flow-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
      border-radius: 24px;
      font-weight: 600;
      color: #1a237e;
    }

    .flow-step .material-icons {
      font-size: 20px;
    }

    .flow-arrow {
      font-size: 24px;
      color: #9e9e9e;
    }

    .intro-note {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      font-size: 13px;
      color: #795548;
    }

    /* テーマカード */
    .theme-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .theme-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .theme-card:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    .theme-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
    }

    .theme-number {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .theme-info {
      flex: 1;
    }

    .theme-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 4px;
    }

    .theme-source {
      font-size: 12px;
      color: #888;
    }

    .theme-buttons {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: #fafafa;
    }

    .theme-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      font-family: inherit;
    }

    .theme-btn .material-icons {
      font-size: 20px;
    }

    /* インプットボタン */
    .btn-input {
      background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
      color: white;
    }

    .btn-input:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(21, 101, 192, 0.4);
    }

    .btn-input.completed {
      background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
    }

    .btn-input.in-progress {
      background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);
    }

    /* アウトプットボタン */
    .btn-output {
      background: linear-gradient(135deg, #e65100 0%, #f57c00 100%);
      color: white;
    }

    .btn-output:hover:not(.locked) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(230, 81, 0, 0.4);
    }

    .btn-output.locked {
      background: #e0e0e0;
      color: #9e9e9e;
      cursor: not-allowed;
    }

    .btn-output.locked:hover {
      transform: none;
      box-shadow: none;
    }

    /* ステータスバッジ */
    .status-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.3);
    }

    .btn-input.completed .status-badge {
      background: rgba(255,255,255,0.3);
    }

    /* 外部リンク */
    .theme-external {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      background: #f5f5f5;
      color: #666;
      font-size: 13px;
      text-decoration: none;
      transition: background 0.3s;
    }

    .theme-external:hover {
      background: #eeeeee;
      color: #1a237e;
    }

    /* ローディング */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .loading-spinner .material-icons {
      font-size: 48px;
      color: #1a237e;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    /* レスポンシブ */
    @media (max-width: 600px) {
      .theme-header {
        flex-wrap: wrap;
      }

      .theme-buttons {
        flex-direction: column;
      }

      .intro-flow {
        flex-direction: column;
      }

      .flow-arrow {
        transform: rotate(90deg);
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="back-btn">
      <span class="material-icons">arrow_back</span>
    </a>
    <span class="header-title">授業書類</span>
  </div>

  <div class="container">
    <!-- 説明セクション -->
    <div class="intro-section">
      <div class="intro-title">
        <span class="material-icons">school</span>
        本質理解からの実践
      </div>
      <div class="intro-flow">
        <div class="flow-step">
          <span class="material-icons">menu_book</span>
          インプット（読む・見る）
        </div>
        <span class="material-icons flow-arrow">arrow_forward</span>
        <div class="flow-step">
          <span class="material-icons">edit_note</span>
          アウトプット（書く・練習）
        </div>
        <span class="material-icons flow-arrow">arrow_forward</span>
        <div class="flow-step">
          <span class="material-icons">replay</span>
          リドゥ（再学習・改善）
        </div>
      </div>
      <div class="intro-note">
        ⚠️ インプットを完了しないとアウトプットに進めません。必ず順番に取り組んでください。
      </div>
    </div>

    <!-- テーマ一覧 -->
    <div class="theme-grid" id="themeGrid">
      <!-- JavaScriptで生成 -->
    </div>
  </div>

  <!-- ローディング -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <span class="material-icons">sync</span>
      <span>読み込み中...</span>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXdCxzPU6oXAm2Mi9mfMDeNvQAyE0mmTOABA2EOYelvX6J2Rr48VcizS0vMgIS7Qc7/exec';
    
    let currentUser = null;
    let progressData = {};

    // テーマ定義
    const themes = [
      {
        id: 1,
        title: '総合型選抜／推薦入試の本質と基礎原則',
        source: '考え方編・有益情報編',
        inputType: 'test', // 理解テスト
        inputPage: 'input-01-sougoukosen.html',
        outputPage: 'output-01-sougoukosen.html'
      },
      {
        id: 2,
        title: '「すき」を見つけ、伸ばし、学問に繋げる',
        source: '考え方編・有益情報編・志望理由書編',
        inputType: 'self', // 自己申告
        inputPage: 'input-02-suki.html',
        outputPage: 'output-02-suki.html'
      },
      {
        id: 3,
        title: '併願校／志望校戦略の本質理解',
        source: '志望校編・併願校編',
        inputType: 'self',
        inputPage: 'input-03-shibouko.html',
        outputPage: null, // 別ページへ誘導
        externalLink: 'exam-schedule.html',
        externalText: '受験スケジュール・志望校戦略シートへ'
      },
      {
        id: 4,
        title: '志望理由書の本質理解から実践',
        source: '志望理由書編',
        inputType: 'self',
        inputPage: 'input-04-shibouriyuu.html',
        outputPage: 'output-04-shibouriyuu.html'
      },
      {
        id: 5,
        title: '自己推薦書の本質理解から実践',
        source: '自己推薦書編',
        inputType: 'self',
        inputPage: 'input-05-jikosuisen.html',
        outputPage: 'output-05-jikosuisen.html'
      },
      {
        id: 6,
        title: 'レポートの本質理解から実践',
        source: 'レポート編',
        inputType: 'self',
        inputPage: 'input-06-report.html',
        outputPage: 'output-06-report.html'
      },
      {
        id: 7,
        title: '小論文の本質理解から実践',
        source: '小論文編',
        inputType: 'self',
        inputPage: 'input-07-shouronbun.html',
        outputPage: 'output-07-shouronbun.html'
      },
      {
        id: 8,
        title: '面接の本質理解から実践',
        source: '面接編',
        inputType: 'column', // コラム完了
        inputPage: 'input-08-mensetsu.html',
        outputPage: 'output-08-mensetsu.html'
      },
      {
        id: 9,
        title: 'プレゼンテーションの本質理解から実践',
        source: 'プレゼンテーション編',
        inputType: 'self',
        inputPage: 'input-09-presen.html',
        outputPage: 'output-09-presen.html'
      }
    ];

    // 初期化
    document.addEventListener('DOMContentLoaded', async function() {
      // ログインチェック
      const userData = localStorage.getItem('eqao_user');
      if (!userData) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = JSON.parse(userData);

      // 進捗データ読み込み
      await loadProgress();

      // テーマカード描画
      renderThemes();

      // ローディング非表示
      document.getElementById('loadingOverlay').style.display = 'none';
    });

    // 進捗データ読み込み
    async function loadProgress() {
      try {
        // サーバーから読み込み
        const res = await fetch(`${API_URL}?action=getLessonProgress&studentId=${currentUser.studentId}`);
        const result = await res.json();
        
        if (result.success && result.progress) {
          progressData = result.progress;
          // ローカルにもバックアップ
          localStorage.setItem(`eqao_lesson_progress_${currentUser.studentId}`, JSON.stringify(progressData));
        } else {
          // フォールバック：ローカルストレージ
          const saved = localStorage.getItem(`eqao_lesson_progress_${currentUser.studentId}`);
          if (saved) {
            progressData = JSON.parse(saved);
          }
        }
      } catch (error) {
        console.error('進捗読み込みエラー:', error);
        // フォールバック：ローカルストレージ
        const saved = localStorage.getItem(`eqao_lesson_progress_${currentUser.studentId}`);
        if (saved) {
          progressData = JSON.parse(saved);
        }
      }
    }

    // テーマカード描画
    function renderThemes() {
      const container = document.getElementById('themeGrid');
      
      container.innerHTML = themes.map(theme => {
        const progress = progressData[theme.id] || {};
        const inputCompleted = progress.inputCompleted || false;
        const inputProgress = progress.inputProgress || 0; // 0-100
        
        // インプットボタンの状態
        let inputClass = 'btn-input';
        let inputLabel = 'インプット';
        let inputIcon = 'menu_book';
        
        if (inputCompleted) {
          inputClass += ' completed';
          inputLabel = '完了';
          inputIcon = 'check_circle';
        } else if (inputProgress > 0) {
          inputClass += ' in-progress';
          inputLabel = `${inputProgress}%`;
          inputIcon = 'pending';
        }

        // アウトプットボタンの状態
        let outputClass = 'btn-output';
        let outputDisabled = '';
        let outputIcon = 'edit_note';
        
        if (!inputCompleted) {
          outputClass += ' locked';
          outputDisabled = 'disabled';
          outputIcon = 'lock';
        }

        // 外部リンクがある場合
        let outputHtml = '';
        if (theme.externalLink) {
          outputHtml = `
            <a href="${theme.externalLink}" class="theme-external">
              <span class="material-icons">open_in_new</span>
              ${theme.externalText}
            </a>
          `;
        } else if (theme.outputPage) {
          outputHtml = `
            <div class="theme-buttons">
              <a href="${theme.inputPage}" class="theme-btn ${inputClass}">
                <span class="material-icons">${inputIcon}</span>
                ${inputLabel}
              </a>
              <a href="${inputCompleted ? theme.outputPage : '#'}" 
                 class="theme-btn ${outputClass}"
                 ${!inputCompleted ? 'onclick="showLockedMessage(event)"' : ''}>
                <span class="material-icons">${outputIcon}</span>
                アウトプット
              </a>
            </div>
          `;
        } else {
          outputHtml = `
            <div class="theme-buttons">
              <a href="${theme.inputPage}" class="theme-btn ${inputClass}">
                <span class="material-icons">${inputIcon}</span>
                ${inputLabel}
              </a>
            </div>
            <a href="${theme.externalLink}" class="theme-external">
              <span class="material-icons">open_in_new</span>
              ${theme.externalText}
            </a>
          `;
        }

        return `
          <div class="theme-card" data-theme-id="${theme.id}">
            <div class="theme-header">
              <div class="theme-number">${theme.id}</div>
              <div class="theme-info">
                <div class="theme-title">${theme.title}</div>
                <div class="theme-source">${theme.source}</div>
              </div>
            </div>
            ${theme.externalLink && !theme.outputPage ? `
              <div class="theme-buttons">
                <a href="${theme.inputPage}" class="theme-btn ${inputClass}">
                  <span class="material-icons">${inputIcon}</span>
                  ${inputLabel}
                </a>
              </div>
              <a href="${theme.externalLink}" class="theme-external">
                <span class="material-icons">open_in_new</span>
                ${theme.externalText}
              </a>
            ` : `
              <div class="theme-buttons">
                <a href="${theme.inputPage}" class="theme-btn ${inputClass}">
                  <span class="material-icons">${inputIcon}</span>
                  ${inputLabel}
                </a>
                ${theme.outputPage ? `
                  <a href="${inputCompleted ? theme.outputPage : '#'}" 
                     class="theme-btn ${outputClass}"
                     ${!inputCompleted ? 'onclick="showLockedMessage(event)"' : ''}>
                    <span class="material-icons">${outputIcon}</span>
                    アウトプット
                  </a>
                ` : ''}
              </div>
            `}
          </div>
        `;
      }).join('');
    }

    // ロックメッセージ
    function showLockedMessage(event) {
      event.preventDefault();
      alert('インプットを完了してからアウトプットに進んでください。');
    }
  </script>
</body>
</html>
